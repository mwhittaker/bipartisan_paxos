% https://tex.stackexchange.com/a/226010
\newcommand{\LineComment}[1]{\textcolor{gray}{// #1}}

\tikzstyle{comm}=[-latex, thick]
\tikzstyle{commnum}=[fill=white, inner sep=0pt]

\begin{figure*}[t]
  \centering
  \begin{tikzpicture}
    \tikzstyle{proc}=[thick, text width=0.45\textwidth]
    \node[proc, draw=\leadercolor, label={90:Leader}] (leader) at (0, 0) {%
      \newcommand{\leaderindex}{\text{leader index}}
      \newcommand{\nextid}{\text{next id}}
      \begin{algorithmic}[1]
        \GlobalState $\leaderindex{}$ \LineComment{e.g., $l_0$ has index $0$}
        \GlobalState $\nextid{} = 0$
        \Upon{receiving command $x$ from client}
          \State $v_x \gets (\leaderindex{}, \nextid{})$
          \State $\nextid{} \gets \nextid + 1$
          \State send $\msg{v_x, x}$ to dependency service nodes
        \EndUpon
        \Upon{receiving dependencies from $f + 1$ dependency service nodes for vertex $v_x$}
          \State Let $\deps{}_1, \ldots, \deps{}_{f+1}$ be the dependencies
          \State $\deps{}_x \gets \bigcup_i \deps{}_i$
          \State send $\msg{v_x, x, \deps{}_x}$ to a proposer
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\depservicecolor, label={90:Dependency Service Node},
          right=of leader] (depservice) {%
      \newcommand{\commands}{\text{cmds}}
      \newcommand{\cache}{\text{cache}}
      \begin{algorithmic}[1]
        \GlobalState $\commands$ \LineComment{set of messages $\msg{v_x, x}$}
        \GlobalState $\cache$ \LineComment{cache from $v_x$ to $\deps{}_x$}
        \Upon{receiving $\msg{v_x, x}$ from leader $l$}
          \If{$v_x$ in $\cache$}
            \State send $\msg{v_x, x, \cache[v_x]}$ to $l$
          \Else{}
            \State $\deps{} = \setst{v_y}{\msg{v_y, y} \in \commands \land
                                          \text{$x$, $y$ conflict}}$
            \State $\cache[v_x] = \deps{}_x$
            \State send $\msg{v_x, x, \deps{}_x}$ to $l$
          \EndIf{}
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\proposercolor, label={Proposer}, below=of leader] (proposer) {%
      \begin{algorithmic}[1]
        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from leader}
          \State send $\msg{v_x, x, \deps{}_x}$ to consensus service
        \EndUpon

        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from consensus service}
          \State send $\msg{v_x, x, \deps{}_x}$ to replicas
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\consensuscolor, label={Consensus}, right=of proposer] (consensus) {%
      \begin{algorithmic}[1]
        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from proposer $p$}
          \State reach consensus on $(x', \deps{}_x')$ for vertex $v_x$
          \State send $\msg{v_x, x', \deps{}_x'}$ to $p$
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\replicacolor, label={Replica}, below=of proposer] (replica) {%
      \newcommand{\replicaIndex}{\text{replica index}}
      \newcommand{\numReplicas}{\text{num replicas}}
      \begin{algorithmic}[1]
        \GlobalState graph \LineComment{BPaxos graph of chosen vertices}
        \GlobalState $\replicaIndex{}$ \LineComment{e.g., $r_0$ has index $0$}
        % \GlobalState \numReplicas \LineComment{the number of replicas}
        % \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from proposer}
        %   \State add $\msg{v_x, x, \deps{}_x}$ to graph
        %   \State execute every eligible vertex $v_y$
        %   \If{$v_y \bmod \numReplicas = \replicaIndex$}
        %     \State send result of executing $v_y$ back to client
        %   \EndIf
        % \EndUpon
      \end{algorithmic}
    };

    \draw[comm, bend left=5] (leader) to node[commnum] {$2$} (depservice);
    \draw[comm, bend left=5] (depservice) to node[commnum] {$3$} (leader);
    \draw[comm, bend right] (leader) to node[commnum] {$4$} (proposer);
    \draw[comm, bend left=5] (proposer) to node[commnum] {$5$} (consensus);
    \draw[comm, bend left=5] (consensus) to node[commnum] {$6$} (proposer);
    \draw[comm, bend right=45] (proposer) to node[commnum] {$7$} (replica);
  \end{tikzpicture}
  \caption{}
  \figlabel{BPaxosPseudocode}
\end{figure*}


% \begin{figure}[ht]
%   \begin{minipage}[t]{0.48\textwidth}
%     \begin{algorithm}[H]
%       \caption{Fast Paxos Phase 2a}%
%       \algolabel{FastPaxos}
%       \begin{algorithmic}[1]
%         \State $M \gets$ phase 1b messages from a quorum $\Quorum$
%         \State $k \gets$ the largest vote round in $M$
%         \State $V \gets$ the vote values in $M$ for round $k$
%         \If{$k = -1$}\linelabel{FastPaxosCase1}
%           \State send any proposed value \linelabel{FastPaxosCase1Code}
%         \ElsIf{$V = \set{v}$}\linelabel{FastPaxosCase2}
%           \State send $v$ \linelabel{FastPaxosCase2Code}
%         \ElsIf{$\exists v \in V.\ O4(v)$}\linelabel{FastPaxosCase3}
%           \State send $v$ \linelabel{FastPaxosCase3Code}
%         \Else{}\linelabel{FastPaxosCase4}
%           \State send any proposed value \linelabel{FastPaxosCase4Code}
%         \EndIf{}
%       \end{algorithmic}
%     \end{algorithm}
%   \end{minipage}%
%   \hspace{0.04\textwidth}%
%   \begin{minipage}[t]{0.48\textwidth}
%     \begin{algorithm}[H]
%       \caption{Fast Paxos Phase 2a Tweak}%
%       \algolabel{FastPaxosTweak}
%       \begin{algorithmic}[1]
%         \State $M \gets$ phase 1b messages from a quorum $\Quorum$
%         \State $k \gets$ the largest vote round in $M$
%         \State $V \gets$ the vote values in $M$ for round $k$
%         \If{$k = -1$}\linelabel{FastPaxosTweakCase1}
%           \State send any proposed value \linelabel{FastPaxosTweakCase1Code}
%         \ElsIf{$k \neq 0$}\linelabel{FastPaxosTweakCase2}
%           \State send unique $v \in V$ \linelabel{FastPaxosTweakCase2Code}
%         \ElsIf{$\exists v \in V$ maybe chosen in round $0$}\linelabel{FastPaxosTweakCase3}
%           \State send $v$ \linelabel{FastPaxosTweakCase3Code}
%         \Else{}\linelabel{FastPaxosTweakCase4}
%           \State send any proposed value \linelabel{FastPaxosTweakCase4Code}
%         \EndIf{}
%       \end{algorithmic}
%     \end{algorithm}
%   \end{minipage}
% \end{figure}
%
