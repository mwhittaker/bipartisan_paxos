% https://tex.stackexchange.com/a/226010
\newcommand{\LineComment}[1]{\textcolor{gray}{// #1}}

\tikzstyle{comm}=[-latex, thick]
\tikzstyle{commnum}=[fill=white, inner sep=0pt]

\begin{figure*}[t]
  \centering
  \begin{tikzpicture}
    \tikzstyle{proc}=[thick, text width=0.45\textwidth]
    \node[proc, draw=\leadercolor, label={90:Leader}] (leader) at (0, 0) {%
      \newcommand{\leaderindex}{\textsf{leader index}}
      \newcommand{\nextid}{\textsf{next id}}
      \begin{algorithmic}[1]
        \GlobalState $\leaderindex{}$ \LineComment{e.g., $l_0$ has index $0$}
        \GlobalState $\nextid{} = 0$
        \Upon{receiving command $x$ from client}
          \State $v_x \gets (\leaderindex{}, \nextid{})$
          \State $\nextid{} \gets \nextid + 1$
          \State send $\msg{v_x, x}$ to dependency service nodes
        \EndUpon
        \Upon{receiving dependencies from $f + 1$ dependency service nodes for vertex $v_x$}
          \State Let $\deps{}_1, \ldots, \deps{}_{f+1}$ be the dependencies
          \State $\deps{}_x \gets \bigcup_i \deps{}_i$
          \State send $\msg{v_x, x, \deps{}_x}$ to a proposer
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\depservicecolor, label={90:Dependency Service Node},
          right=of leader] (depservice) {%
      \newcommand{\commands}{\textsf{cmds}}
      \begin{algorithmic}[1]
        \GlobalState $\commands$ \LineComment{set of messages $\msg{v_x, x}$}
        \Upon{receiving $\msg{v_x, x}$ from leader $l$}
          \State $\deps{} = \setst{v_y}{\msg{v_y, y} \in \commands \land
                                        \text{$x$, $y$ conflict}}$
          \State send $\msg{v_x, x, \deps{}_x}$ to $l$
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\proposercolor, label={Proposer}, below=of leader] (proposer) {%
      \begin{algorithmic}[1]
        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from leader}
          \State send $\msg{v_x, x, \deps{}_x}$ to consensus service
        \EndUpon

        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from consensus service}
          \State send $\msg{v_x, x, \deps{}_x}$ to replicas
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\consensuscolor, label={Consensus}, right=of proposer] (consensus) {%
      \begin{algorithmic}[1]
        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from proposer $p$}
          \State reach consensus on $(x', \deps{}_x')$ for vertex $v_x$
          \State send $\msg{v_x, x', \deps{}_x'}$ to $p$
        \EndUpon
      \end{algorithmic}
    };

    \node[proc, draw=\replicacolor, label={Replica}, below=of proposer] (replica) {%
      \newcommand{\replicaIndex}{\textsf{replica index}}
      \newcommand{\numReplicas}{\textsf{num replicas}}
      \begin{algorithmic}[1]
        \GlobalState graph \LineComment{BPaxos graph of chosen vertices}
        \GlobalState $\numReplicas{}$ \LineComment{the number of replicas}
        \Upon{receiving $\msg{v_x, x, \deps{}_x}$ from proposer}
          \State add $\msg{v_x, x, \deps{}_x}$ to graph
          \State execute every eligible vertex $v_y$
          \If{$v_y~\%~\numReplicas = \replicaIndex$}
            \State send result of executing $v_y$ back to client
          \EndIf
        \EndUpon
      \end{algorithmic}
    };

    \draw[comm, bend left=5] (leader) to node[commnum] {$2$} (depservice);
    \draw[comm, bend left=5] (depservice) to node[commnum] {$3$} (leader);
    \draw[comm, bend right] (leader) to node[commnum] {$4$} (proposer);
    \draw[comm, bend left=5] (proposer) to node[commnum] {$5$} (consensus);
    \draw[comm, bend left=5] (consensus) to node[commnum] {$6$} (proposer);
    \draw[comm, bend right=45] (proposer) to node[commnum] {$7$} (replica);
  \end{tikzpicture}

  \caption{BPaxos pseudocode}
  \figlabel{BPaxosPseudocode}
\end{figure*}
