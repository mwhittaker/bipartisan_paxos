\newcommand{\nullbot}{\textsf{null}}
\newcommand{\maj}[1]{\textsf{maj}(#1)}

\begin{algorithm}[ht]
  \caption{Fast Paxos Proposer}%
  \algolabel{FastPaxosProposer}
  \begin{algorithmic}[1]
    \GlobalState a value $x$, initially \nullbot{}
    \GlobalState a round $i$, initially $-1$

    \Upon{%
      receiving \msg{Phase2B}{0, y} from $f + \maj{f+1}$ acceptors as
      the proposer of round $0$
    }
      \If{every value of $y$ is the same}
        \State $y$ is chosen, notify the replicas
      \Else{}
        \State $i \gets 1$
        \State $x \gets$ an arbitrary value of $y$
        \State send \msg{Phase2a}{1, x} to at least $f + 1$ acceptors
      \EndIf
    \EndUpon

    \Upon{receiving \msg{Phase2B}{i} from $f+1$ acceptors}
      \State $x$ is chosen, notify the replicas
    \EndUpon

    \Upon{recovery}
      \State $i \gets$ next largest round owned by this proposer
      \State send \msg{Phase1A}{i} to at least $f+1$ acceptors
    \EndUpon

    \Upon{receiving \msg{Phase1B}{i, vr, vv} from $f+1$ acceptors}
      \State $k \gets$ the largest $vr$ in any \msg{PhaseIB}{i, vr, vv}
      \If{$k = -1$}
        \State $x \gets$ an arbitrary value
      \ElsIf{$k > 0$}
        \State $x \gets$ the corresponding $vv$ in round $k$
      \ElsIf{$k = 0$}
        \If{there are $\maj{f + 1}$ \msg{Phase1B}{i, k, y} messages for some value $y$}
          \State $x \gets$ $y$
        \Else{}
          \State $x \gets$ an arbitrary value of $vv$
        \EndIf
      \EndIf
      \State send \msg{Phase2a}{i, x} to at least $f + 1$ acceptors
    \EndUpon
  \end{algorithmic}
\end{algorithm}
